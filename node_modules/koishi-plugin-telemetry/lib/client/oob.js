"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.inject = exports.name = void 0;
exports.apply = apply;
const koishi_1 = require("koishi");
const node_path_1 = require("node:path");
exports.name = 'telemetry-oob-client';
exports.inject = ['console'];
function apply(ctx, storage) {
    ctx.console.addListener('dismiss', (reason) => {
        void (async () => {
            try {
                await Promise.any([
                    storage.basis.post('/dismiss', {
                        reason,
                    }),
                    (0, koishi_1.sleep)(3000),
                ]);
            }
            catch (e) {
                // Ignore
            }
            storage.root.update((config) => {
                config.mode = 'readonly';
                return config;
            });
        })();
    });
    ctx.console.addListener('accept', () => {
        void storage.commitPrivacy();
        ctx.scope.dispose();
    });
    ctx.console.addEntry({
        dev: (0, node_path_1.resolve)(__dirname, '../../clients/oob/client/index.ts'),
        prod: (0, node_path_1.resolve)(__dirname, '../../clients/oob/dist'),
    });
}
