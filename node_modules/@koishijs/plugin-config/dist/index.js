import{store as S,ScopeStatus as ne,send as A,router as ae,useMenu as Ve,useContext as fe,clone as $e,message as le,Schema as we,useI18nText as Le,icons as G,Service as be}from"@koishijs/client";import{ref as N,computed as O,defineComponent as K,resolveComponent as L,openBlock as u,createBlock as w,unref as _,createElementBlock as V,createVNode as h,createElementVNode as f,onActivated as xe,watch as te,withCtx as p,toDisplayString as z,normalizeClass as re,createCommentVNode as U,nextTick as ue,provide as oe,Fragment as T,renderList as ee,createTextVNode as I,withModifiers as X,withKeys as ce,inject as Me,renderSlot as de,h as He}from"vue";import{useRoute as me,useRouter as ze}from"vue-router";const q=N(),Y=N(),_e=["@koishijs/plugin-console","@koishijs/plugin-config","@koishijs/plugin-server"];function ie(a){if(_e.includes("@koishijs/plugin-"+a.name))return true;if(a.children)return a.children.some(ie)}function Se(a){var r,s,c,C,m,H,g,b,x,M,P;function l($,W){i.has($)||$!=="console"&&(t.using[$]={required:W})}const o=S.packages[a],t={impl:[],using:{},peer:{}},i=new Set;for(const $ in o.package.peerDependencies??{}){if(!$.includes("@koishijs/plugin-")&&!$.includes("koishi-plugin-")||_e.includes($))continue;const W=!((s=(r=o.package.peerDependenciesMeta)==null?void 0:r[$])!=null&&s.optional),k=!!((C=(c=S.packages[$])==null?void 0:c.runtime)!=null&&C.id);t.peer[$]={required:W,active:k};for(const e of((H=(m=S.packages[$])==null?void 0:m.manifest)==null?void 0:H.service.implements)??[])i.add(e)}for(const $ of o.manifest.service.implements)$!=="adapter"&&t.impl.push($);for(const $ of((g=o.runtime)==null?void 0:g.required)??[])l($,true);for(const $ of((b=o.runtime)==null?void 0:b.optional)??[])l($,false);return(x=o.runtime)!=null&&x.id&&!((M=o.runtime)!=null&&M.forkable)&&(t.warning=true),(P=o.runtime)!=null&&P.schema||(t.warning=true),t}const ge=O(()=>Object.fromEntries(Object.keys(S.packages).filter(a=>a).map(a=>[a,Se(a)]))),E=N();function se(a){if(!a)return a;if(a.includes("/")){const[l,o]=a.split("/");return[`${l}/koishi-plugin-${o}`].find(t=>t in S.packages)}return[`@koishijs/plugin-${a}`,`koishi-plugin-${a}`].find(l=>l in S.packages)}const Z=O(()=>{if(E.value)return se(E.value.name)}),Ue=O(()=>{const a=ge.value[Z.value];if(a){if(a.warning&&E.value.disabled)return"warning";for(const l in a.using)if(l in S.services,a.impl.includes(l))return"warning"}});function ve(a,l){const o=[];for(let t in l){if(t.startsWith("$"))continue;const i=l[t],r={config:i,parent:a};t.startsWith("~")&&(r.disabled=true,t=t.slice(1)),r.name=t.split(":",1)[0],r.id=t,r.path=t.slice(r.name.length+1),r.label=i==null?void 0:i.$label,t.startsWith("group:")&&(r.children=ve(r,i)),o.push(r)}return o}const D=O(()=>{const a={name:"",id:"",path:"",label:"全局设置",config:S.config,children:[]},l=[a],o=[],t={},i={"":a};for(const s of ve(a,S.config.plugins))l.push(s),r(s);function r(s){var c,C,m;!((c=s.config)!=null&&c.$collapsed)&&s.children&&o.push(s.path),t[C=s.name]||(t[C]=[]),t[s.name].push(s.path),i[s.path]=s,(m=s.children)==null||m.forEach(r)}return{data:l,forks:t,paths:i,expanded:o}});function he(a){var l,o,t,i,r;switch((r=(i=(t=(o=(l=S.packages)==null?void 0:l[se(a.name)])==null?void 0:o.runtime)==null?void 0:t.forks)==null?void 0:i[a.path])==null?void 0:r.status){case ne.PENDING:return"pending";case ne.LOADING:return"loading";case ne.ACTIVE:return"active";case ne.FAILED:return"failed";case ne.DISPOSED:return"disposed";default:return"disabled"}}async function Ce(a){var l;A("manager/remove",((l=a.parent)==null?void 0:l.path)??"",a.id),await ae.replace("/plugins/"+a.parent.path)}const je=K({__name:"global",props:{current:{},modelValue:{}},emits:["update:modelValue"],setup(a,{emit:l}){const o=a,t=l,i=O({get:()=>o.modelValue,set:r=>t("update:modelValue",r)});return(r,s)=>{const c=L("k-form");return u(),w(c,{schema:_(S).packages[""].runtime.schema,initial:r.current.config,modelValue:i.value,"onUpdate:modelValue":s[0]||(s[0]=C=>i.value=C)},null,8,["schema","initial","modelValue"])}}}),Ee={class:"modifier"},Ne=f("h2",{class:"k-schema-header"},"过滤器设置",-1),ke=K({__name:"modifier",props:{modelValue:{}},emits:["update:modelValue"],setup(a,{emit:l}){const o=a,t=l,i=O({get:()=>{var r;return(r=o.modelValue)==null?void 0:r.$filter},set:r=>t("update:modelValue",{...o.modelValue,$filter:r})});return(r,s)=>{const c=L("k-filter");return u(),V("div",Ee,[Ne,h(c,{modelValue:i.value,"onUpdate:modelValue":s[0]||(s[0]=C=>i.value=C)},null,8,["modelValue"])])}}});const De=K({__name:"group",props:{current:{},modelValue:{}},emits:["update:modelValue"],setup(a,{emit:l}){const o=a,t=l,i=O({get:()=>o.modelValue,set:r=>t("update:modelValue",r)});return(r,s)=>(u(),w(ke,{modelValue:i.value,"onUpdate:modelValue":s[0]||(s[0]=c=>i.value=c)},null,8,["modelValue"]))}});const F=(a,l)=>{const o=a.__vccOpts||a;for(const[t,i]of l)o[t]=i;return o},Be=F(De,[["__scopeId","data-v-5d5f677a"]]),Ie={class:"search"},Oe=["title"],Te={class:"right"},Ae=K({__name:"tree",props:{modelValue:{}},emits:["update:modelValue"],setup(a,{expose:l,emit:o}){const t=a,i=me(),r=Ve("config.tree"),s=o,c=N(null),C=N(null),m=N("");function H(d,y){return y.name.toLowerCase().includes(m.value.toLowerCase())}const g=N(true);async function b(){var B;await ue();const d=(B=c.value)==null?void 0:B.$el,y=d==null?void 0:d.querySelector(".el-tree-node.is-active");!y||!y.offsetTop&&i.path.slice(9)||c.value.setScrollTop(y.offsetTop-(d.offsetHeight-y.offsetHeight)/2)}l({activate:b}),xe(async()=>{b(),g.value=false});function x(d){!d||g.value||b()}function M(d){return d.data.name==="group"?"分组："+(d.label||d.data.path):d.label||d.data.name||"待添加"}function P(d){return d.data.path!==""}function $(d,y,B){return B!=="inner"?y.data.path!==""||B==="next":y.data.id.startsWith("group:")}function W(d,y,B,J){s("update:modelValue",d.path),window.dispatchEvent(new MouseEvent(J.type,J))}function k(d,y,B){A("manager/meta",d.path,{$collapsed:null})}function e(d,y,B){A("manager/meta",d.path,{$collapsed:true})}function n(d,y,B,J){var R;const v=B==="inner"?y:y.parent;let Q=v.childNodes.findIndex(ye=>ye.data.path===d.data.path);v.data.path||(Q-=1),A("manager/teleport",((R=d.data.parent)==null?void 0:R.path)??"",d.data.id,v.data.path,Q)}function j(d){const y=[];return d.children&&y.push("is-group"),!d.children&&!se(d.name)&&y.push("is-disabled"),d.path===t.modelValue&&y.push("is-active"),y.join(" ")}return te(m,d=>{C.value.filter(d)}),(d,y)=>{const B=L("k-icon"),J=L("el-input"),v=L("el-tree"),Q=L("el-scrollbar");return u(),w(Q,{class:"plugin-tree",ref_key:"root",ref:c},{default:p(()=>[f("div",Ie,[h(J,{modelValue:m.value,"onUpdate:modelValue":y[0]||(y[0]=R=>m.value=R)},{suffix:p(()=>[h(B,{name:"search"})]),_:1},8,["modelValue"])]),h(v,{ref_key:"tree",ref:C,"node-key":"path",data:_(D).data,draggable:true,"auto-expand-parent":false,"default-expanded-keys":_(D).expanded,"expand-on-click-node":false,"filter-node-method":H,props:{class:j},"allow-drag":P,"allow-drop":$,onNodeClick:W,onNodeContextmenu:_(r),onNodeDrop:n,onNodeExpand:k,onNodeCollapse:e},{default:p(({node:R})=>[f("div",{class:"item",ref:x},[f("div",{class:"label",title:M(R)},z(M(R)),9,Oe),f("div",Te,[_(se)(R.data.name)?(u(),V("span",{key:0,class:re(["status-light",_(he)(R.data)])},null,2)):U("v-if",true)])])]),_:1},8,["data","default-expanded-keys","props","onNodeContextmenu"])]),_:1},512)}}});const Pe=f("p",null,"正在加载插件配置……",-1),We=f("p",null,"此插件已在运行且不可重用，启用可能会导致非预期的问题。",-1),Fe=f("span",null,"此插件提供了页面：",-1),Ge=f("p",null,"此插件尚未安装。",-1),Re=K({__name:"plugin",props:{current:{},modelValue:{}},emits:["update:modelValue"],setup(a,{emit:l}){const o=a,t=l,i=fe(),r=O({get:()=>o.modelValue,set:m=>t("update:modelValue",m)}),s=O(()=>ge.value[Z.value]),c=O(()=>S.packages[Z.value]),C=O(()=>c.value.workspace?"请检查插件源代码。":"请联系插件作者并反馈此问题。");return te(c,m=>{!m||m.runtime||A("config/request-runtime",m.name)},{immediate:true}),oe("plugin:name",Z),oe("plugin:env",s),oe("manager.settings.local",c),oe("manager.settings.config",r),oe("manager.settings.current",O(()=>o.current)),(m,H)=>{const g=L("k-comment"),b=L("k-slot"),x=L("k-slot-item"),M=L("k-activity-link"),P=L("k-markdown"),$=L("k-form");return _(Z)?(u(),V(T,{key:0},[c.value.runtime?c.value.runtime.failed?(u(),w(g,{key:1,type:"danger"},{default:p(()=>[f("p",null,"插件加载失败，这可能是插件本身的问题所致。"+z(C.value),1)]),_:1})):(u(),w(b,{key:2,name:"plugin-details"},{default:p(()=>{var W;return[U(" dependency "),h(x,{order:800},{default:p(()=>[h(b,{name:"plugin-dependency",single:""},{default:p(()=>[(u(true),V(T,null,ee(s.value.peer,({required:k,active:e},n)=>(u(),w(g,{key:n,type:e?"success":k?"warning":"primary"},{default:p(()=>[f("p",null,z(k?"必需":"可选")+"依赖："+z(n)+" ("+z(e?"已加载":"未加载")+") ",1)]),_:2},1032,["type"]))),128)),(u(true),V(T,null,ee(s.value.using,({required:k},e)=>(u(),w(g,{key:e,type:e in _(S).services?"success":k?"warning":"primary"},{default:p(()=>[f("p",null,z(k?"必需":"可选")+"服务："+z(e)+" ("+z(e in _(S).services?"已加载":"未加载")+") ",1)]),_:2},1032,["type"]))),128))]),_:1})]),_:1}),U(" implements "),h(x,{order:600},{default:p(()=>[(u(true),V(T,null,ee(s.value.impl,k=>(u(),V(T,{key:k},[k in _(S).services&&m.current.disabled?(u(),w(g,{key:0,type:"warning"},{default:p(()=>[f("p",null,"此插件将会提供 "+z(k)+" 服务，但此服务已被其他插件实现。",1)]),_:2},1024)):(u(),w(g,{key:1,type:m.current.disabled?"primary":"success"},{default:p(()=>[f("p",null,"此插件"+z(m.current.disabled?"启用后将会提供":"提供了")+" "+z(k)+" 服务。",1)]),_:2},1032,["type"]))],64))),128))]),_:1}),U(" reusability "),h(x,{order:400},{default:p(()=>{var k;return[c.value.runtime.id&&!c.value.runtime.forkable&&m.current.disabled?(u(),w(g,{key:0,type:"warning"},{default:p(()=>[We]),_:1})):U("v-if",true),((k=_(D).forks[m.current.name])==null?void 0:k.length)>1?(u(),w(g,{key:1,type:"primary"},{default:p(()=>[f("p",null,[I("此插件存在多份配置，"),f("span",{class:"k-link",onClick:H[0]||(H[0]=X(e=>q.value=_(Z),["stop"]))},"点击前往管理"),I("。")])]),_:1})):U("v-if",true)]}),_:1}),U(" implements "),h(x,{order:300},{default:p(()=>[(u(true),V(T,null,ee(_(i).$router.pages,(k,e)=>{var n;return u(),V(T,{key:e},[(n=k.ctx.extension)!=null&&n.paths.includes(m.current.path)&&!k.disabled()?(u(),w(g,{key:0,type:"success"},{default:p(()=>[f("p",null,[Fe,h(M,{id:k.id},null,8,["id"])])]),_:2},1024)):U("v-if",true)],64)}),128))]),_:1}),U(" usage "),(W=c.value.runtime)!=null&&W.usage?(u(),w(x,{key:0,order:-200},{default:p(()=>{var k;return[h(P,{unsafe:"",class:"usage",source:(k=c.value.runtime)==null?void 0:k.usage},null,8,["source"])]}),_:1})):U("v-if",true),U(" modifier "),h(x,{order:-600},{default:p(()=>[c.value.runtime.filter!==false?(u(),w(ke,{key:0,modelValue:r.value,"onUpdate:modelValue":H[1]||(H[1]=k=>r.value=k)},null,8,["modelValue"])):U("v-if",true)]),_:1}),U(" config "),h(x,{order:-1e3},{default:p(()=>[c.value.runtime.schema?(u(),w($,{key:1,schema:c.value.runtime.schema,initial:m.current.config,modelValue:r.value,"onUpdate:modelValue":H[2]||(H[2]=k=>r.value=k)},{hint:p(()=>[I(z(C.value),1)]),_:1},8,["schema","initial","modelValue"])):(u(),w(g,{key:0,type:"warning"},{default:p(()=>[f("p",null,"此插件未声明配置项，这可能并非预期行为。"+z(C.value),1)]),_:1}))]),_:1})]}),_:1})):(u(),w(g,{key:0},{default:p(()=>[Pe]),_:1}))],64)):(u(),w(b,{key:1,name:"plugin-missing",single:""},{default:p(()=>[h(g,{type:"danger"},{default:p(()=>[Ge]),_:1})]),_:1}))}}});const qe=K({__name:"index",setup(a){const l=me(),o=ze(),t=O({get(){const e=l.path.slice(9);return e in D.value.paths?e:""},set(e){e in D.value.paths||(e=""),o.replace("/plugins/"+e)}}),i=N(),r=N(""),s=N(),c=N();async function C(){var e;await ue(),(e=s.value)==null||e.focus()}const m=N(),H=N(false),g=N(),b=N(false),x=N(null);te(m,e=>{e&&(H.value=true)}),te(g,e=>{e&&(b.value=true)}),te(()=>D.value.paths[t.value],e=>{E.value=e,i.value=$e(e.config)},{immediate:true});const M=fe();M.define("config.tree",E),M.action("config.tree.add-plugin",{hidden:({config:e})=>e.tree.path&&!e.tree.children,action:({config:e})=>Y.value=e.tree}),M.action("config.tree.add-group",{hidden:({config:e})=>e.tree.path&&!e.tree.children,action:({config:e})=>{x.value=e.tree.path}});function P(e){const n=Math.random().toString(36).slice(2,8);A("manager/reload",x.value,`group:${n}`,{$label:e}),o.replace("/plugins/"+n),x.value=null}M.action("config.tree.clone",{hidden:({config:e})=>!e.tree.path||!!e.tree.children,action:async({config:e})=>{var y;const j=(e.tree.parent.path?e.tree.parent.children:D.value.data.slice(1)).findIndex(B=>B.path===e.tree.path),d=Math.random().toString(36).slice(2,8);A("manager/unload",((y=e.tree.parent)==null?void 0:y.path)??"",`${e.tree.name}:${d}`,e.tree.config,j+1),o.replace(`/plugins/${d}`)}}),M.action("config.tree.manage",{hidden:({config:e})=>!e.tree.path||!!e.tree.children,action:async({config:e})=>{q.value=e.tree.name}}),M.action("config.tree.rename",{disabled:({config:e})=>!e.tree.path,action:({config:e})=>{r.value=e.tree.label||(e.tree.name==="group"?e.tree.path:e.tree.name),g.value=e.tree}}),M.action("config.tree.remove",{disabled:({config:e})=>!e.tree.path||ie(e.tree),action:({config:e})=>m.value=e.tree});function $(e){var j;let n=(j=S.packages[se(e)])==null?void 0:j.runtime.schema;if(!n)return true;try{return new we(n)(i.value),true}catch{return le.error("当前配置项不满足约束，请检查配置！"),false}}M.action("config.tree.save",{shortcut:"ctrl+s",disabled:e=>{var n,j,d;return!((n=e==null?void 0:e.config)!=null&&n.tree)||!["config"].includes((d=(j=o.currentRoute.value)==null?void 0:j.meta)==null?void 0:d.activity.id)},action:async({config:{tree:e}})=>{const{disabled:n,path:j}=e;if(!(!n&&!$(e.name))){if(!j)return A("manager/app-reload",i.value);try{await W(e,n?"unload":"reload"),le.success(n?"配置已保存。":"配置已重载。")}catch{le.error("操作失败，请检查日志！")}}}}),M.action("config.tree.toggle",{disabled:({config:e})=>!e.tree.path||ie(e.tree),action:async({config:{tree:e}})=>{const{disabled:n,name:j}=e;if(!(n&&!$(e.name)))try{await W(e,n?"reload":"unload"),le.success((j==="group"?"分组":"插件")+(n?"已启用。":"已停用。"))}catch{le.error("操作失败，请检查日志！")}}});async function W(e,n){var j;await A(`manager/${n}`,((j=e.parent)==null?void 0:j.path)??"",e.id,i.value)}function k(e,n){b.value=false,e.label=n,A("manager/meta",e.path,{$label:n||null})}return(e,n)=>{const j=L("k-content"),d=L("el-button"),y=L("el-dialog"),B=L("el-input"),J=L("k-layout");return u(),w(J,{menu:"config.tree","menu-data":_(E)},{header:p(()=>[U(" root "),_(E).path?_(E).children?(u(),V(T,{key:1},[U(" group "),I(" 分组："+z(_(E).label||_(E).id),1)],64)):(u(),V(T,{key:2},[U(" plugin "),I(z(_(E).label||_(E).name)+" ["+z(_(E).path)+"] ",1)],64)):(u(),V(T,{key:0},[I("全局设置")],64))]),left:p(()=>[h(Ae,{ref_key:"tree",ref:c,modelValue:t.value,"onUpdate:modelValue":n[0]||(n[0]=v=>t.value=v)},null,8,["modelValue"])]),default:p(()=>[(u(),w(j,{class:"plugin-view",key:t.value},{default:p(()=>[_(E).path?_(E).children?(u(),w(Be,{key:1,modelValue:i.value,"onUpdate:modelValue":n[2]||(n[2]=v=>i.value=v),current:_(E)},null,8,["modelValue","current"])):(u(),w(Re,{key:2,current:_(E),modelValue:i.value,"onUpdate:modelValue":n[3]||(n[3]=v=>i.value=v)},null,8,["current","modelValue"])):(u(),w(je,{key:0,current:_(E),modelValue:i.value,"onUpdate:modelValue":n[1]||(n[1]=v=>i.value=v)},null,8,["current","modelValue"]))]),_:1})),h(y,{modelValue:H.value,"onUpdate:modelValue":n[6]||(n[6]=v=>H.value=v),title:"确认移除","destroy-on-close":"",onClosed:n[7]||(n[7]=v=>m.value=null)},{footer:p(()=>[h(d,{onClick:n[4]||(n[4]=v=>H.value=false)},{default:p(()=>[I("取消")]),_:1}),h(d,{type:"danger",onClick:n[5]||(n[5]=v=>{var Q;return H.value=false,_(Ce)(m.value),(Q=c.value)==null?void 0:Q.activate()})},{default:p(()=>[I("确定")]),_:1})]),default:p(()=>[m.value?(u(),V(T,{key:0},[I(" 确定要移除"+z(m.value.children?`分组 ${m.value.label||m.value.path}`:`插件 ${m.value.label||m.value.name}`)+" 吗？此操作不可撤销！ ",1)],64)):U("v-if",true)]),_:1},8,["modelValue"]),h(y,{modelValue:b.value,"onUpdate:modelValue":n[12]||(n[12]=v=>b.value=v),title:"重命名","destroy-on-close":"",onOpen:C,onClosed:n[13]||(n[13]=v=>g.value=null)},{footer:p(()=>[h(d,{onClick:n[10]||(n[10]=v=>b.value=false)},{default:p(()=>[I("取消")]),_:1}),h(d,{type:"primary",onClick:n[11]||(n[11]=v=>k(g.value,r.value))},{default:p(()=>[I("确定")]),_:1})]),default:p(()=>[g.value?(u(),w(B,{key:0,ref_key:"inputEl",ref:s,modelValue:r.value,"onUpdate:modelValue":n[8]||(n[8]=v=>r.value=v),onKeydown:n[9]||(n[9]=ce(X(v=>k(g.value,r.value),["stop","prevent"]),["enter"]))},null,8,["modelValue"])):U("v-if",true)]),_:1},8,["modelValue"]),h(y,{"model-value":x.value!==null,"onUpdate:modelValue":n[18]||(n[18]=v=>x.value=null),title:"创建分组","destroy-on-close":"",onOpen:C},{footer:p(()=>[h(d,{onClick:n[16]||(n[16]=v=>x.value=null)},{default:p(()=>[I("取消")]),_:1}),h(d,{type:"primary",onClick:n[17]||(n[17]=v=>P(r.value))},{default:p(()=>[I("确定")]),_:1})]),default:p(()=>[h(B,{ref_key:"inputEl",ref:s,modelValue:r.value,"onUpdate:modelValue":n[14]||(n[14]=v=>r.value=v),onKeydown:n[15]||(n[15]=ce(X(v=>P(r.value),["stop","prevent"]),["enter"]))},null,8,["modelValue"])]),_:1},8,["model-value"])]),_:1},8,["menu-data"])}}});const Ke=["id"],Je={class:"text-left"},Qe={class:"path"},Xe={class:"text-right"},Ye={class:"actions"},Ze=["onClick"],et=["onClick"],tt={class:"left"},nt={class:"right"},lt=K({__name:"forks",setup(a){const l=O(()=>{var s;return(s=q.value)==null?void 0:s.replace(/(koishi-|^@koishijs\/)plugin-/,"")}),o=O(()=>{var s;return(s=S.packages)==null?void 0:s[q.value]});function t(s){return`${s.label?`${s.label} `:""}[${s.path}]`}function i(s){const c=[t(s)];for(;s.parent;)s=s.parent,c.unshift(t(s));return c.shift(),c.join(" > ")}async function r(s){const c=l.value;s||(s=Math.random().toString(36).slice(2,8),A("manager/unload","",c+":"+s,{})),await ae.push("/plugins/"+s),q.value=null}return(s,c)=>{const C=L("k-icon"),m=L("el-button"),H=L("el-dialog");return u(),w(H,{"model-value":!!_(q),"onUpdate:modelValue":c[1]||(c[1]=g=>q.value=null),class:"dialog-config-fork","destroy-on-close":""},{header:p(({titleId:g,titleClass:b})=>{var x;return[f("span",{id:g,class:re(b)},z(_(q)+((x=o.value)!=null&&x.workspace?" (工作区)":"")),11,Ke)]}),footer:p(()=>{var g,b;return[f("div",tt,[(g=_(D).forks[l.value])!=null&&g.length?(u(),V(T,{key:0},[I(" 此插件目前存在 "+z((b=_(D).forks[l.value])==null?void 0:b.length)+" 份配置。 ",1)],64)):(u(),V(T,{key:1},[I(" 此插件尚未被配置。 ")],64))]),f("div",nt,[h(m,{onClick:c[0]||(c[0]=X(x=>r(),["stop"]))},{default:p(()=>[I("添加新配置")]),_:1})])]}),default:p(()=>[f("table",null,[(u(true),V(T,null,ee(_(D).forks[l.value],g=>(u(),V("tr",{key:g},[f("td",Je,[f("span",{class:re(["status-light",_(he)(_(D).paths[g])])},null,2),f("span",Qe,z(i(_(D).paths[g])),1)]),f("td",Xe,[f("span",Ye,[f("span",{class:"action",onClick:X(b=>r(g),["stop"])},[h(C,{name:"arrow-right"})],8,Ze),f("span",{class:"action",onClick:X(b=>_(Ce)(_(D).paths[g]),["stop"])},[h(C,{name:"delete"})],8,et)])])]))),128))])]),_:1},8,["model-value"])}}});const ot=f("span",{class:"title"},"选择插件",-1),at={class:"content"},st=["onClick"],pe=K({__name:"select",setup(a){const l=Le(),o=N(""),t=N(),i=Me("plugin-select-filter",c=>true),r=O(()=>Object.values(S.packages).filter(({name:c,shortname:C})=>c&&C.includes(o.value.toLowerCase())&&i(S.packages[c])));function s(c){const C=Y.value.path,m=Math.random().toString(36).slice(2,8);Y.value=null,o.value="",A("manager/unload",C,c+":"+m,{}),ae.push("/plugins/"+m)}return te(Y,async c=>{c&&(await ue(),await t.value.focus())},{flush:"post"}),(c,C)=>{const m=L("k-icon"),H=L("el-input"),g=L("k-markdown"),b=L("el-scrollbar"),x=L("el-dialog");return _(S).packages?(u(),w(x,{key:0,modelValue:!!_(Y),"onUpdate:modelValue":C[1]||(C[1]=M=>Y.value=null),class:"plugin-select"},{header:p(()=>[de(c.$slots,"title",{packages:r.value},()=>[ot]),h(H,{ref_key:"input",ref:t,modelValue:o.value,"onUpdate:modelValue":C[0]||(C[0]=M=>o.value=M)},{suffix:p(()=>[h(m,{name:"search"})]),_:1},8,["modelValue"])]),default:p(()=>[de(c.$slots,"tabs",{packages:r.value}),f("div",at,[h(b,null,{default:p(()=>[(u(true),V(T,null,ee(r.value,({name:M,shortname:P,manifest:$})=>(u(),V("div",{class:"package",key:M,onClick:X(W=>s(P),["stop"])},[f("h3",null,z(P),1),h(g,{inline:"",class:"desc",source:_(l)($.description)},null,8,["source"])],8,st))),128))]),_:1})])]),_:3},8,["modelValue"])):U("v-if",true)}}});const rt={},it={class:"k-icon",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 512 512"},ut=f("path",{fill:"currentColor",d:"M452 60H488C499 60 508 68.95 508 80C508 91.05 499 100 488 100H452V136C452 147 443 156 432 156C420.1 156 412 147 412 136V100H376C364.1 100 356 91.05 356 80C356 68.95 364.1 60 376 60H412V24C412 12.95 420.1 4 432 4C443 4 452 12.95 452 24V60zM280.8 133.1L490.1 222.8C503.4 228.5 512 241.5 512 256C512 270.5 503.4 283.5 490.1 289.2L280.8 378.9C272.1 382.3 264.5 384 256 384C247.5 384 239 382.3 231.2 378.9L21.9 289.2C8.614 283.5 0 270.5 0 256C0 241.5 8.614 228.5 21.9 222.8L231.2 133.1C239 129.7 247.5 128 256 128C264.5 128 272.1 129.7 280.8 133.1V133.1zM66.26 256L250.1 334.8C251.1 335.6 253.1 336 256 336C258 336 260 335.6 261.9 334.8L445.7 256L261.9 177.2C260 176.4 258 176 256 176C253.1 176 251.1 176.4 250.1 177.2L66.26 256zM59.53 350.6C66.15 359.9 65.24 372.3 57.1 380.5L250.1 462.8C251.1 463.6 253.1 464 256 464C258 464 260 463.6 261.9 462.8L452 381.3C447.4 374.4 446.5 365.2 450.5 357.3C456.5 345.4 470.9 340.6 482.7 346.5L491.8 351.1C504.2 357.3 512 369.9 512 383.7C512 398.4 503.3 411.6 489.9 417.3L280.8 506.9C272.1 510.3 264.5 512 256 512C247.5 512 239 510.3 231.2 506.9L22.81 417.6C8.971 411.7 .001 398.1 .001 383C.001 370.9 5.87 359.5 15.76 352.4L26.05 345C36.84 337.3 51.83 339.8 59.53 350.6L59.53 350.6z"},null,-1),ct=[ut];function dt(a,l){return u(),V("svg",it,ct)}const pt=F(rt,[["render",dt]]),ft={},mt={class:"k-icon",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 512 512"},_t=f("path",{fill:"currentColor",d:`M144,0c13.3,0,24,10.8,24,24v88h-48V24C120,10.8,130.8,0,144,0z M336,0c13.3,0,24,10.8,24,24v88h-48V24
      C312,10.8,322.7,0,336,0z M408,144c13.3,0,24,10.7,24,24s-10.7,24-24,24h-8v64c0,80.2-59.9,146.6-136,158.2V512h-48v-97.8
      c-77-11.6-136-78-136-158.2v-64h-8c-13.2,0-24-10.7-24-24s10.8-24,24-24H408z M240,368c61.9,0,112-50.1,112-112v-64H128v64
      C128,317.9,178.1,368,240,368z`},null,-1),gt=f("path",{fill:"currentColor",d:`M444,416h36c11,0,20,9,20,20s-9,20-20,20h-36v36c0,11-9,20-20,20c-11.9,0-20-9-20-20v-36h-36c-11.9,0-20-9-20-20
      s8.1-20,20-20h36v-36c0-11,8.1-20,20-20c11,0,20,9,20,20V416z`},null,-1),vt=[_t,gt];function ht(a,l){return u(),V("svg",mt,vt)}const Ct=F(ft,[["render",ht]]),kt={},yt={class:"k-icon",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 448 512"},Vt=f("path",{fill:"currentColor",d:"M160 400C160 408.8 152.8 416 144 416C135.2 416 128 408.8 128 400V192C128 183.2 135.2 176 144 176C152.8 176 160 183.2 160 192V400zM240 400C240 408.8 232.8 416 224 416C215.2 416 208 408.8 208 400V192C208 183.2 215.2 176 224 176C232.8 176 240 183.2 240 192V400zM320 400C320 408.8 312.8 416 304 416C295.2 416 288 408.8 288 400V192C288 183.2 295.2 176 304 176C312.8 176 320 183.2 320 192V400zM317.5 24.94L354.2 80H424C437.3 80 448 90.75 448 104C448 117.3 437.3 128 424 128H416V432C416 476.2 380.2 512 336 512H112C67.82 512 32 476.2 32 432V128H24C10.75 128 0 117.3 0 104C0 90.75 10.75 80 24 80H93.82L130.5 24.94C140.9 9.357 158.4 0 177.1 0H270.9C289.6 0 307.1 9.358 317.5 24.94H317.5zM151.5 80H296.5L277.5 51.56C276 49.34 273.5 48 270.9 48H177.1C174.5 48 171.1 49.34 170.5 51.56L151.5 80zM80 432C80 449.7 94.33 464 112 464H336C353.7 464 368 449.7 368 432V128H80V432z"},null,-1),$t=[Vt];function wt(a,l){return u(),V("svg",yt,$t)}const Lt=F(kt,[["render",wt]]),bt={},xt={class:"k-icon check",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 448 512"},Mt=f("path",{fill:"currentColor",d:"M438.6 105.4C451.1 117.9 451.1 138.1 438.6 150.6L182.6 406.6C170.1 419.1 149.9 419.1 137.4 406.6L9.372 278.6C-3.124 266.1-3.124 245.9 9.372 233.4C21.87 220.9 42.13 220.9 54.63 233.4L159.1 338.7L393.4 105.4C405.9 92.88 426.1 92.88 438.6 105.4H438.6z"},null,-1),Ht=[Mt];function zt(a,l){return u(),V("svg",xt,Ht)}const St=F(bt,[["render",zt]]),Ut={},jt={class:"k-icon",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 512 512"},Et=f("path",{fill:"currentColor",d:"M64 464H288C296.8 464 304 456.8 304 448V384H352V448C352 483.3 323.3 512 288 512H64C28.65 512 0 483.3 0 448V224C0 188.7 28.65 160 64 160H128V208H64C55.16 208 48 215.2 48 224V448C48 456.8 55.16 464 64 464zM160 64C160 28.65 188.7 0 224 0H448C483.3 0 512 28.65 512 64V288C512 323.3 483.3 352 448 352H224C188.7 352 160 323.3 160 288V64zM224 304H448C456.8 304 464 296.8 464 288V64C464 55.16 456.8 48 448 48H224C215.2 48 208 55.16 208 64V288C208 296.8 215.2 304 224 304z"},null,-1),Nt=[Et];function Dt(a,l){return u(),V("svg",jt,Nt)}const Bt=F(Ut,[["render",Dt]]),It={},Ot={class:"k-icon",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 512 512"},Tt=f("path",{fill:"currentColor",d:"M81.84 152.1C77.43 156.9 71.21 159.8 64.63 159.1C58.05 160.2 51.69 157.6 47.03 152.1L7.029 112.1C-2.343 103.6-2.343 88.4 7.029 79.03C16.4 69.66 31.6 69.66 40.97 79.03L63.08 101.1L118.2 39.94C127 30.09 142.2 29.29 152.1 38.16C161.9 47.03 162.7 62.2 153.8 72.06L81.84 152.1zM81.84 312.1C77.43 316.9 71.21 319.8 64.63 319.1C58.05 320.2 51.69 317.6 47.03 312.1L7.029 272.1C-2.343 263.6-2.343 248.4 7.029 239C16.4 229.7 31.6 229.7 40.97 239L63.08 261.1L118.2 199.9C127 190.1 142.2 189.3 152.1 198.2C161.9 207 162.7 222.2 153.8 232.1L81.84 312.1zM216 120C202.7 120 192 109.3 192 96C192 82.75 202.7 72 216 72H488C501.3 72 512 82.75 512 96C512 109.3 501.3 120 488 120H216zM192 256C192 242.7 202.7 232 216 232H488C501.3 232 512 242.7 512 256C512 269.3 501.3 280 488 280H216C202.7 280 192 269.3 192 256zM160 416C160 402.7 170.7 392 184 392H488C501.3 392 512 402.7 512 416C512 429.3 501.3 440 488 440H184C170.7 440 160 429.3 160 416zM64 448C46.33 448 32 433.7 32 416C32 398.3 46.33 384 64 384C81.67 384 96 398.3 96 416C96 433.7 81.67 448 64 448z"},null,-1),At=[Tt];function Pt(a,l){return u(),V("svg",Ot,At)}const Wt=F(It,[["render",Pt]]),Ft={},Gt={class:"k-icon",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 512 512"},Rt=f("path",{fill:"currentColor",d:"M168 255.1C168 207.4 207.4 167.1 256 167.1C304.6 167.1 344 207.4 344 255.1C344 304.6 304.6 344 256 344C207.4 344 168 304.6 168 255.1zM256 199.1C225.1 199.1 200 225.1 200 255.1C200 286.9 225.1 311.1 256 311.1C286.9 311.1 312 286.9 312 255.1C312 225.1 286.9 199.1 256 199.1zM65.67 230.6L25.34 193.8C14.22 183.7 11.66 167.2 19.18 154.2L49.42 101.8C56.94 88.78 72.51 82.75 86.84 87.32L138.8 103.9C152.2 93.56 167 84.96 182.8 78.43L194.5 25.16C197.7 10.47 210.7 0 225.8 0H286.2C301.3 0 314.3 10.47 317.5 25.16L329.2 78.43C344.1 84.96 359.8 93.56 373.2 103.9L425.2 87.32C439.5 82.75 455.1 88.78 462.6 101.8L492.8 154.2C500.3 167.2 497.8 183.7 486.7 193.8L446.3 230.6C447.4 238.9 448 247.4 448 255.1C448 264.6 447.4 273.1 446.3 281.4L486.7 318.2C497.8 328.3 500.3 344.8 492.8 357.8L462.6 410.2C455.1 423.2 439.5 429.2 425.2 424.7L373.2 408.1C359.8 418.4 344.1 427 329.2 433.6L317.5 486.8C314.3 501.5 301.3 512 286.2 512H225.8C210.7 512 197.7 501.5 194.5 486.8L182.8 433.6C167 427 152.2 418.4 138.8 408.1L86.84 424.7C72.51 429.2 56.94 423.2 49.42 410.2L19.18 357.8C11.66 344.8 14.22 328.3 25.34 318.2L65.67 281.4C64.57 273.1 64 264.6 64 255.1C64 247.4 64.57 238.9 65.67 230.6V230.6zM158.4 129.2L145.1 139.5L77.13 117.8L46.89 170.2L99.58 218.2L97.39 234.8C96.47 241.7 96 248.8 96 255.1C96 263.2 96.47 270.3 97.39 277.2L99.58 293.8L46.89 341.8L77.13 394.2L145.1 372.5L158.4 382.8C169.5 391.4 181.9 398.6 195 403.1L210.5 410.4L225.8 480H286.2L301.5 410.4L316.1 403.1C330.1 398.6 342.5 391.4 353.6 382.8L366.9 372.5L434.9 394.2L465.1 341.8L412.4 293.8L414.6 277.2C415.5 270.3 416 263.2 416 256C416 248.8 415.5 241.7 414.6 234.8L412.4 218.2L465.1 170.2L434.9 117.8L366.9 139.5L353.6 129.2C342.5 120.6 330.1 113.4 316.1 108L301.5 101.6L286.2 32H225.8L210.5 101.6L195 108C181.9 113.4 169.5 120.6 158.4 129.2H158.4z"},null,-1),qt=[Rt];function Kt(a,l){return u(),V("svg",Gt,qt)}const Jt=F(Ft,[["render",Kt]]),Qt={},Xt={class:"k-icon",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 384 512"},Yt=f("path",{fill:"currentColor",d:"M24.52 38.13C39.66 29.64 58.21 29.99 73.03 39.04L361 215C375.3 223.8 384 239.3 384 256C384 272.7 375.3 288.2 361 296.1L73.03 472.1C58.21 482 39.66 482.4 24.52 473.9C9.377 465.4 0 449.4 0 432V80C0 62.64 9.377 46.63 24.52 38.13V38.13zM48 432L336 256L48 80V432z"},null,-1),Zt=[Yt];function en(a,l){return u(),V("svg",Xt,Zt)}const tn=F(Qt,[["render",en]]),nn={},ln={class:"k-icon",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 384 512"},on=f("path",{fill:"currentColor",d:"M320 64H64c-35.35 0-64 28.65-64 64v255.1c0 35.35 28.65 64 64 64H320c35.35 0 64-28.65 64-64V128C384 92.65 355.3 64 320 64zM336 384c0 8.822-7.178 16-16 16H64c-8.822 0-16-7.178-16-16V128c0-8.822 7.178-16 16-16h256c8.822 0 16 7.178 16 16V384z"},null,-1),an=[on];function sn(a,l){return u(),V("svg",ln,an)}const rn=F(nn,[["render",sn]]),un={},cn={class:"k-icon",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 448 512"},dn=f("path",{fill:"currentColor",d:"M224 256c-35.2 0-64 28.8-64 64c0 35.2 28.8 64 64 64c35.2 0 64-28.8 64-64C288 284.8 259.2 256 224 256zM433.1 129.1l-83.9-83.9C341.1 37.06 328.8 32 316.1 32H64C28.65 32 0 60.65 0 96v320c0 35.35 28.65 64 64 64h320c35.35 0 64-28.65 64-64V163.9C448 151.2 442.9 138.9 433.1 129.1zM128 80h144V160H128V80zM400 416c0 8.836-7.164 16-16 16H64c-8.836 0-16-7.164-16-16V96c0-8.838 7.164-16 16-16h16v104c0 13.25 10.75 24 24 24h192C309.3 208 320 197.3 320 184V83.88l78.25 78.25C399.4 163.2 400 164.8 400 166.3V416z"},null,-1),pn=[dn];function fn(a,l){return u(),V("svg",cn,pn)}const mn=F(un,[["render",fn]]);G.register("activity:plugin",Jt);G.register("add-group",pt);G.register("add-plugin",Ct);G.register("trash-can",Lt);G.register("check",St);G.register("clone",Bt);G.register("manage",Wt);G.register("play",tn);G.register("stop",rn);G.register("save",mn);class hn extends be{constructor(l){super(l,"configWriter",true),l.slot({type:"global",component:K(()=>()=>He(L("k-slot"),{name:"plugin-select",single:true}))}),l.slot({type:"plugin-select-base",component:pe,order:-1e3}),l.slot({type:"plugin-select",component:pe,order:-1e3}),l.slot({type:"global",component:lt}),l.page({id:"config",path:"/plugins/:name*",name:"插件配置",icon:"activity:plugin",order:800,authority:4,fields:["config","packages","services"],component:qe}),l.menu("config.tree",[{id:"config.tree.toggle",type:({config:o})=>{var t;return(t=o.tree)!=null&&t.disabled?"":Ue.value},icon:({config:o})=>{var t;return(t=o.tree)!=null&&t.disabled?"play":"stop"},label:({config:o})=>{var t,i;return((t=o.tree)!=null&&t.disabled?"启用":"停用")+(((i=o.tree)==null?void 0:i.name)==="group"?"分组":"插件")}},{id:".save",icon:({config:o})=>{var t;return(t=o.tree)!=null&&t.disabled?"save":"check"},label:({config:o})=>{var t;return(t=o.tree)!=null&&t.disabled?"保存配置":"重载配置"}},{id:"@separator"},{id:".rename",icon:"edit",label:"重命名"},{id:".remove",type:"danger",icon:"delete",label:({config:o})=>{var t;return(t=o.tree)!=null&&t.children?"移除分组":"移除插件"}},{id:"@separator"},{id:".clone",icon:"clone",label:"克隆配置"},{id:".manage",icon:"manage",label:"管理多份配置"},{id:".add-plugin",icon:"add-plugin",label:"添加插件"},{id:".add-group",icon:"add-group",label:"添加分组"}])}ensure(l,o){const t=l.replace(/(koishi-|^@koishijs\/)plugin-/,""),i=D.value.forks[t];if(i!=null&&i.length)i.length===1?o||ae.push("/plugins/"+i[0]):o||(q.value=l);else{const r=Math.random().toString(36).slice(2,8);A("manager/unload","",t+":"+r,{}),o||ae.push("/plugins/"+r)}}remove(l){var i;const o=l.replace(/(koishi-|^@koishijs\/)plugin-/,""),t=D.value.forks[o];for(const r of t){const s=D.value.paths[r];A("manager/remove",((i=s.parent)==null?void 0:i.path)??"",s.id)}}get(l){var t;const o=l.replace(/(koishi-|^@koishijs\/)plugin-/,"");return(t=D.value.forks[o])==null?void 0:t.map(i=>D.value.paths[i])}}export{_e as coreDeps,E as current,hn as default,q as dialogFork,Y as dialogSelect,ge as envMap,se as getFullName,he as getStatus,ie as hasCoreDeps,Z as name,D as plugins,Ce as removeItem,Ue as type};
